<% Account.where.not(code: [ACCOUNT_CODE_EARNED_SURPLUS_CARRIED_FORWARD]).where(trade_type: TRADE_TYPE_EXTERNAL).order(:code).each do |a| %>
  <%
    sql = SqlBuilder.new
    sql.append('journal_headers.ym in (?)', @fiscal_year.year_month_range)
    sql.append('and journal_headers.slip_type in(?)', EXTERNAL_SLIP_TYPES.keys)
    sql.append('and exists (')
    sql.append('  select 1 from journal_details')
    sql.append('  where journal_details.journal_header_id = journal_headers.id')
    sql.append('    and journal_details.account_id = ?', a.id)
    sql.append(')')

    journal_headers = JournalHeader.where(sql.to_a)
    next unless journal_headers.present?
  %>
  <div class="alwaysbreak">
    <table account_code="<%= a.code %>" dc_type="<%= a.dc_type %>" class="ledger">
      <thead>
        <tr>
          <th colspan="3"><%= to_wareki(@fiscal_year.fiscal_year) %>年　<%= a.code_and_name %></th>
        </tr>
        <tr>
          <th class="yearMonth">年月</th>
          <th class="day">日</th>
          <th class="remarks">摘要</th>
          <th class="accountName">相手勘定科目</th>
          <% if branch_mode %>
          <th class="branchName">相手計上部門</th>
          <% end %>
          <th class="amountDebit">借方</th>
          <th class="amountCredit">貸方</th>
          <th class="amountSum">累計</th>
        </tr>
      </thead>
      <tbody>
        <%
          finder = LedgerFinder.new(company_id: @fiscal_year.company_id, fiscal_year: @fiscal_year.fiscal_year, account_id: a.id)
          sum = finder.get_last_year_balance || 0
        %>
        <% if a.bs? %>
          <tr style="background-color: papayawhip;">
            <td class="yearMonth"></td>
            <td class="day"></td>
            <td class="remarks">前期末残高</td>
            <td class="accountName"></td>
            <% if branch_mode %>
              <td class="branchName"></td>
            <% end %>
            <td class="amountDebit"></td>
            <td class="amountCredit"></td>
            <td class="amountSum"><%= to_amount(sum, show_zero: true) %></td>
          </tr>
        <% end %>

        <% journal_headers.order('ym, day, id').map{|jh| Ledger.new(jh, finder) }.each do |ledger| %>
          <tr class="nobreak">
            <td class="yearMonth"><%= ledger.ym %></td>
            <td class="day"><%= ledger.day %></td>
            <td class="remarks"><%= ledger.remarks %></td>
            <td class="accountName"><%= ledger.account_name %></td>
            <% if branch_mode %>
            <td class="branchName"><%= ledger.branch_name %></td>
            <% end %>
            <td class="amountDebit"><%= to_amount(ledger.amount_debit) %></td>
            <td class="amountCredit"><%= to_amount(ledger.amount_credit) %></td>
            <td class="amountSum"><%= to_amount(sum += ledger.net_amount, show_zero: true) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
